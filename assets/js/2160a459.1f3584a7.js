(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{214:function(e,t,n){"use strict";n.d(t,"a",(function(){return u})),n.d(t,"b",(function(){return b}));var r=n(0),a=n.n(r);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)n=o[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),p=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=p(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},m=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),u=p(n),m=r,b=u["".concat(s,".").concat(m)]||u[m]||d[m]||o;return n?a.a.createElement(b,i(i({ref:t},l),{},{components:n})):a.a.createElement(b,i({ref:t},l))}));function b(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,s=new Array(o);s[0]=m;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:r,s[1]=i;for(var l=2;l<o;l++)s[l]=n[l];return a.a.createElement.apply(null,s)}return a.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},89:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return i})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return p}));var r=n(3),a=n(7),o=(n(0),n(214)),s={title:"Securing NATS"},i={unversionedId:"cluster-operations/nats-tls",id:"version-2.5.0/cluster-operations/nats-tls",isDocsHomePage:!1,title:"Securing NATS",description:"NATS is a messaging server used by the MCCP component. It exposes a TCP endpoint that needs to be reachable by WKP agents running on leaf clusters. This guide describes how to use TLS to secure traffic between leaf clusters and the MCCP server. This guide uses cert-manager to generate the certificate but it still applies and can be used without it. It is highly recommended to enable TLS connections for NATS before adding any leaf clusters to MCCP, otherwise you may need to re-connect any leaf clusters that were added prior to enabling TLS.",source:"@site/versioned_docs/version-2.5.0/cluster-operations/nats-tls.md",slug:"/cluster-operations/nats-tls",permalink:"/docs/cluster-operations/nats-tls",editUrl:"https://github.com/weaveworks/wkp-docs/tree/main/versioned_docs/version-2.5.0/cluster-operations/nats-tls.md",version:"2.5.0",sidebar:"version-2.5.0/docs",previous:{title:"Securing the WKP UI",permalink:"/docs/cluster-operations/auth"},next:{title:"Managing Secrets",permalink:"/docs/cluster-operations/managing-secrets"}},c=[],l={toc:c};function p(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(o.b)("wrapper",Object(r.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"NATS is a messaging server used by the MCCP component. It exposes a TCP endpoint that needs to be reachable by WKP agents running on leaf clusters. This guide describes how to use TLS to secure traffic between leaf clusters and the MCCP server. This guide uses ",Object(o.b)("inlineCode",{parentName:"p"},"cert-manager")," to generate the certificate but it still applies and can be used without it. It is highly recommended to enable TLS connections for NATS ",Object(o.b)("em",{parentName:"p"},"before")," adding any leaf clusters to MCCP, otherwise you may need to re-connect any leaf clusters that were added prior to enabling TLS."),Object(o.b)("p",null,"Setting up TLS for NATS requires the use of a certificate. This certificate can be added to the cluster either manually as a secret or provisioned automatically via ",Object(o.b)("inlineCode",{parentName:"p"},"cert-manager"),".The following manifest shows how to provision such a certificate automatically."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-yaml"},"---\napiVersion: cert-manager.io/v1\nkind: Certificate\nmetadata:\n  name: nats-tls\n  namespace: wkp-gitops-repo-broker\nspec:\n  dnsNames:\n  - <hostname-to-use> # e.g. mccp.wkp.weave.works\n  issuerRef:\n    group: cert-manager.io\n    kind: <issuer-type> # Issuer or ClusterIssuer\n    name: <issuer-name> # the name of an existing Issuer or ClusterIssuer\n  secretName: nats-tls\n  usages:\n  - digital signature\n  - key encipherment\n")),Object(o.b)("p",null,"Add this manifest to the directory ",Object(o.b)("inlineCode",{parentName:"p"},"./cluster/manifests/mccp")," of your cluster repository, then commit and push to your Git provider. The reconciliation process should apply it within a few seconds. Ensure that the certificate has been successfully provisioned by running the following command."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-console"},"kubectl get secrets -n wkp-gitops-repo-broker nats-tls\n")),Object(o.b)("p",null,"Once the new certificate has been provisioned, we need to update the NATS configuration to use it. Update the ConfigMap manifest located in ",Object(o.b)("inlineCode",{parentName:"p"},"./cluster/manifests/mccp/extra-nats-values-configmap.yaml")," which is used for configuring NATS with the following content."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-yaml"},"---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: extra-nats-values\ndata:\n  values.yaml: |\n    auth:\n      enabled: true\n      user: ''\n      token: $NATS_AUTH_TOKEN\n    client:\n      service:\n        type: NodePort\n    extraEnvVarsSecret: nats-env-vars-secret\n    extraFlags:\n      tls: \"\"\n      tlskey: /etc/nats-tls/tls.key\n      tlscert: /etc/nats-tls/tls.crt\n    extraVolumeMounts:\n    - name: nats-tls\n      mountPath: /etc/nats-tls/\n      readOnly: true\n    extraVolumes:\n    - name: nats-tls\n      secret:\n        secretName: nats-tls\n")),Object(o.b)("p",null,"This will result in exposing the TLS certificate as a mounted volume so that it is accessible under the ",Object(o.b)("inlineCode",{parentName:"p"},"/etc/nats-tls")," directory of the NATS container. The ",Object(o.b)("inlineCode",{parentName:"p"},"extraFlags")," configuration that is supplied instructs NATS to require TLS for client connections."),Object(o.b)("p",null,"After this change is applied, NATS will be accessible only via TLS connections. We need to also update ",Object(o.b)("inlineCode",{parentName:"p"},"./cluster/platform/components.js")," to ensure that new agents being created for leaf cluster will get the correct (TLS-enabled) connection details and to ensure that the event-writer component running on the MCCP server itself will also connect to NATS via a TLS connection."),Object(o.b)("p",null,"To update the agent template, edit the following section of ",Object(o.b)("inlineCode",{parentName:"p"},"./cluster/platform/components.js")," to set the scheme to ",Object(o.b)("inlineCode",{parentName:"p"},"tls")," and the URL to the public endpoint that NATS is exposed for the ",Object(o.b)("inlineCode",{parentName:"p"},"wkp-gitops-repo-broker")," cluster component."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-diff"},'const wkpGitopsRepoBroker = {\n    "name": "wkp-gitops-repo-broker",\n    "params": {\n        "git": gitopsParams.git,\n        "gitDeployKey": gitopsSecrets.sealedGitDeployKey["wkp-gitops-repo-broker"],\n        "imagePullSecret": gitopsSecrets.sealedImagePullSecrets.dockerio["wkp-gitops-repo-broker"],\n        "images": gitopsParams.images,\n        "featureGates": enabledFeatures,\n        "agentTemplate": {\n            // nats or tls\n-           "natsScheme": "nats",\n-           "natsURL": "nats-client.wkp-gitops-repo-broker:4222",\n+           "natsScheme": "tls",\n+           "natsURL": "<hostname-to-use>", # e.g. mccp.wkp.weave.works:4222",\n        },\n        dbConfig,\n    },\n}\n')),Object(o.b)("p",null,"Similarly, to update the event-writer component, edit the following section ",Object(o.b)("inlineCode",{parentName:"p"},"./cluster/platform/components.js")," to set the scheme to ",Object(o.b)("inlineCode",{parentName:"p"},"tls")," and the URL to the public endpoint that NATS is exposed for the ",Object(o.b)("inlineCode",{parentName:"p"},"wkp-mccp")," cluster component."),Object(o.b)("pre",null,Object(o.b)("code",{parentName:"pre",className:"language-diff"},"const wkpMccp = {\n  name: 'wkp-mccp',\n  disabled: !enabledFeatures.fleetManagement,\n  params: {\n    dbConfig,\n    // Over-ride the event-write connection\n-   natsScheme: 'nats',\n-   natsURL: 'nats-client.wkp-gitops-repo-broker:4222',\n+   natsScheme: 'tls',\n+   natsURL: '<hostname-to-use>', # e.g. mccp.wkp.weave.works:4222\",\n  },\n};\n")),Object(o.b)("p",null,"Now both components should be able to talk to NATS using a TLS connection."))}p.isMDXComponent=!0}}]);