<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/wkp-docs/blog/rss.xml" title="WKP Technical Documentation Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/wkp-docs/blog/atom.xml" title="WKP Technical Documentation Blog Atom Feed"><title data-react-helmet="true">Managing Secrets | WKP Technical Documentation</title><meta data-react-helmet="true" property="og:url" content="https://weaveworks.github.io/wkp-docs//wkp-docs/docs/cluster-operations/managing-secrets"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="2.4.2"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-2.4.2"><meta data-react-helmet="true" property="og:title" content="Managing Secrets | WKP Technical Documentation"><meta data-react-helmet="true" name="description" content="Kubernetes secrets provide a way to distribute sensitive data into Pods. Secrets are just another object the Kubernetes API can manage and are represented in YAML manifest files. The sensitive data part of a secret will be encoded in base64 format, meaning they are not encrypted. This raises an issue, as committing these manifests in Version Control Systems like Git is not secure."><meta data-react-helmet="true" property="og:description" content="Kubernetes secrets provide a way to distribute sensitive data into Pods. Secrets are just another object the Kubernetes API can manage and are represented in YAML manifest files. The sensitive data part of a secret will be encoded in base64 format, meaning they are not encrypted. This raises an issue, as committing these manifests in Version Control Systems like Git is not secure."><link data-react-helmet="true" rel="shortcut icon" href="/wkp-docs/img/favicon_150px.png"><link data-react-helmet="true" rel="canonical" href="https://weaveworks.github.io/wkp-docs//wkp-docs/docs/cluster-operations/managing-secrets"><link data-react-helmet="true" rel="alternate" href="https://weaveworks.github.io/wkp-docs//wkp-docs/docs/cluster-operations/managing-secrets" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://weaveworks.github.io/wkp-docs//wkp-docs/docs/cluster-operations/managing-secrets" hreflang="x-default"><link rel="stylesheet" href="/wkp-docs/assets/css/styles.7e876baf.css">
<link rel="preload" href="/wkp-docs/assets/js/styles.abc77443.js" as="script">
<link rel="preload" href="/wkp-docs/assets/js/runtime~main.b973e4df.js" as="script">
<link rel="preload" href="/wkp-docs/assets/js/main.d93e75c0.js" as="script">
<link rel="preload" href="/wkp-docs/assets/js/1.7b0384ce.js" as="script">
<link rel="preload" href="/wkp-docs/assets/js/2.e71b656c.js" as="script">
<link rel="preload" href="/wkp-docs/assets/js/98.cac1137d.js" as="script">
<link rel="preload" href="/wkp-docs/assets/js/100.a80eb3bc.js" as="script">
<link rel="preload" href="/wkp-docs/assets/js/cb9bbae0.3572c2dc.js" as="script">
<link rel="preload" href="/wkp-docs/assets/js/17896441.bd7294b6.js" as="script">
<link rel="preload" href="/wkp-docs/assets/js/9dd5f212.3a057d1c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/wkp-docs/"><img src="/wkp-docs/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/wkp-docs/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">WKP Docs</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp-docs/docs/">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp-docs/docs/deploying-wkp/hosts">Install</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp-docs/docs/tasks/using-the-eks-d-distribution">Tasks</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp-docs/docs/cluster-operations/user-workloads">Cluster Operations</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/wkp-docs/docs/">2.4.2</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/wkp-docs/docs/next/cluster-operations/managing-secrets">main</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/wkp-docs/docs/cluster-operations/managing-secrets">2.4.2</a></li></ul></div><a href="https://github.com/weaveworks/wkp-docs/tree/main" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/wkp-docs/"><img src="/wkp-docs/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/wkp-docs/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">WKP Docs</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp-docs/docs/">Getting Started</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp-docs/docs/deploying-wkp/hosts">Install</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp-docs/docs/tasks/using-the-eks-d-distribution">Tasks</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp-docs/docs/cluster-operations/user-workloads">Cluster Operations</a></li><li class="menu__list-item"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/wkp-docs/docs/next/cluster-operations/managing-secrets">main</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/wkp-docs/docs/cluster-operations/managing-secrets">2.4.2</a></li></ul></li><li class="menu__list-item"><a href="https://github.com/weaveworks/wkp-docs/tree/main" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/">Introduction to wk</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/getting-started/wk">The wk command</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/getting-started/entitlements">Configuring Entitlements</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/getting-started/git-config-repository">Managing the Git Configuration Repository</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/getting-started/known-issues">Known Issues and Work Arounds</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Deploying WKP</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/deploying-wkp/hosts">Cluster Node Requirements</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/deploying-wkp/cluster-creation-on-ssh-nodes">Creating Clusters on SSH Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/deploying-wkp/components-on-existing-cluster">Install to an Existing Cluster</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/deploying-wkp/cluster-creation-on-eks">Installing WKP to EKS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/deploying-wkp/cluster-creation-on-ssh-nodes">Creating Clusters on SSH Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/deploying-wkp/cluster-creation-on-footloose">Installing WKP on Footloose</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Team Workspaces</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/team-workspaces/usage-guide">Implementing Team Workspaces</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/team-workspaces/team-permissions">Specifying Team Permissions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/team-workspaces/member-guide">Deploying Workloads</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Cluster Operations</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp-docs/docs/cluster-operations/user-workloads">Running and Managing Workloads</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp-docs/docs/cluster-operations/adding-removing-nodes">Adding and Removing Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp-docs/docs/cluster-operations/upgrading-kubernetes-version">Upgrading Kubernetes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp-docs/docs/cluster-operations/custom-kubernetes-configuration">Customizing the API Server and Kubelet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp-docs/docs/cluster-operations/auth">Securing the WKP UI</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/wkp-docs/docs/cluster-operations/managing-secrets">Managing Secrets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp-docs/docs/cluster-operations/sealing-key">Managing the Sealing Key</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Monitoring</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/monitoring/introduction">WKP Monitoring Tools</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/monitoring/alerts">Alerts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/monitoring/dashboards">Dashboards</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Tasks</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/tasks/using-the-eks-d-distribution">Configuring EKS-D</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/tasks/multiple-cluster-admins">Specifying Multiple Admins</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/tasks/patching-node-os-packages">Patching Node OS packages</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/tasks/profiling-kubectl">Profiling kubectl</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Troubleshooting</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/troubleshooting/help">Debugging a Problem</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/troubleshooting/kubelet">Troubleshooting kubelet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/troubleshooting/controller">Troubleshooting wks-controller</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/troubleshooting/scope">WKP Scope</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/tasks/patching-node-os-packages">Patching Node OS packages</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/tasks/profiling-kubectl">Profiling kubectl</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">FAQ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/FAQ/faq">Frequently Asked Questions</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/reference/reference">Cluster and Machine Objects</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/reference/cluster">cluster.yaml</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/reference/machines">machines.yaml</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Thirdparty Dependencies</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp-docs/docs/deps/dependencies">Third-party Dependencies</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div><span class="badge badge--secondary">Version: 2.4.2</span></div><header><h1 class="docTitle_3a4h">Managing Secrets</h1></header><div class="markdown"><p>Kubernetes secrets provide a way to distribute sensitive data into Pods. Secrets are just another object the Kubernetes API can manage and are represented in YAML manifest files. The sensitive data part of a secret will be encoded in base64 format, meaning they are not encrypted. This raises an issue, as committing these manifests in Version Control Systems like Git is not secure.</p><p><a href="https://github.com/bitnami-labs/sealed-secrets" target="_blank" rel="noopener noreferrer">Bitnami Sealed Secrets</a> is a solution to this problem, providing one-way encrypted secrets that are safe to commit in Git repositories.</p><p>Sealed secrets are based on asymmetric cryptography, making use of a certificate and private key pair in a similar way as to how GPG keys work. The certificate/public key part can be used locally with <code>kubeseal</code> to encrypt a secret, which can be applied to a Kubernetes cluster as any other resource.
The <code>sealed-secrets-controller</code> running in the <code>kube-system</code> namespace by default, will in turn decrypt the sealed secret, using the private key, to a normal Secret resource that can be mounted to Pods in the cluster.</p><p>In the cluster creation step, if you would like to use a specific certificate - key pair, specify it in the main configuration file at <code>setup/config.yaml</code> and WKP will launch the sealed secrets controller with the provided key.
If left blank a new self signed certificate - key pair is created and stored at <code>setup/sealed-secrets-cert.crt</code> and <code>setup/sealed-secrets-key</code>.</p><p><strong>Do not store the private key in any VCS repository.</strong> It should be stored in a password manager of your choice or retrieved from the Secret in the Kubernetes cluster. Compromising the private key annuls any protection provided by the sealed secrets so it needs to be handled with utmost care.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="example-creating-a-sealed-secret"></a>Example: Creating a sealed secret<a class="hash-link" href="#example-creating-a-sealed-secret" title="Direct link to heading">#</a></h3><p>Once the cluster is ready, you can create a sealed secret as described in the following example from <a href="https://engineering.bitnami.com/articles/sealed-secrets.html" target="_blank" rel="noopener noreferrer">bitnami</a>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Creates an example secret and encrypt it immediately:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl create secret generic --dry-run --output json </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  mysecret  --from-literal</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">password</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">supersekret </span><span class="token operator" style="color:rgb(137, 221, 255)">|</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  kubeseal </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> mysealedsecret.json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Add the created sealed secret to your manifests directory of your git repo</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Note this is now safe to do.</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> mysealedsecret.json /path/to/my/repo/cluster/manifests/mysealedsecret.json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># Commit and push</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> /path/to/my/repo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> cluster/manifests/mysealedsecret.json</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> commit -m </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Added a sealed secret&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> push</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># After a few minutes flux will apply the manifest to the cluster</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic"># The original secret now exists, like magic!</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get secret mysecret</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="scopes"></a>Scopes<a class="hash-link" href="#scopes" title="Direct link to heading">#</a></h3><p>Enforcing RBAC for users of a Kubernetes cluster usually entails separating user access to specific namespaces. To ensure that reading a sealed secret is safe, they can include in the encryption process the name of the secret and the namespace. This is the case of sealing a secret in the <code>strict</code> scope. An example of why this is essential is the following:</p><ul><li>Let&#x27;s assume a user of namespace <code>foo</code> reads a sealed secret manifest from Git that is meant for namespace <code>bar</code>.</li><li>He could change the namespace field from <code>bar</code> to <code>foo</code> and create the sealed secret in his namespace <code>foo</code> and read out the value once the controller decrypts it.</li></ul><p>Same example is valid for RBAC within the same namespace, e.g. if the user could only access a secret with a specific name in namespace <code>foo</code>. By changing the name of the secret to <code>foo</code> he could read the decrypted value once the controller decrypts it to a secret he can access.</p><p>The 3 scopes of sealed secrets are:</p><ul><li>strict (default): the secret must be sealed with exactly the same name and namespace. These attributes become part of the encrypted data and thus changing name and/or namespace would lead to &quot;decryption error&quot;.</li><li>namespace-wide: you can freely rename the sealed secret within a given namespace.</li><li>cluster-wide: the secret can be unsealed in any namespace and can be given any name.</li></ul><p>You can select the scope of a secret by passing the <code>--scope</code> flag to kubeseal:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubeseal --scope cluster-wide </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> SECRET.yaml </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> SEALED_SECRET.json</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>If the flag is not passed the default scope is <code>strict</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="key-renewal"></a>Key Renewal<a class="hash-link" href="#key-renewal" title="Direct link to heading">#</a></h3><p><code>Key rotation</code> is critical to the security of any cryptosystem. The recommended procedure of securely managing sealed secrets is referred to as <code>key renewal</code> and it differs from traditional key rotation in ways explained below. For further reading, please refer to the <a href="https://github.com/bitnami-labs/sealed-secrets#secret-rotation" target="_blank" rel="noopener noreferrer">Sealed Secrets README</a> on Github.</p><p>Traditionally, in the example of an access key rotation works by:</p><ol><li>Creating a new key</li><li>Updating all applications to use the new key and validating that they are working</li><li>Labelling as expired the old key and optionally deleting it</li></ol><p>In dealing with sealed secrets in Kubernetes the process differs in these ways:</p><ul><li>Creating a new key and reencrypting the secrets with the new one is not enough, the periodical rotation of the actual secret value is also advised</li><li>&quot;Expired&quot; keys are not automatically deleted, they are kept in a list in the controller and can still be used to decrypt sealed secrets that have been sealed with the old certificate</li></ul><p>Key renewal occurs automatically at the time interval passed to the controller with the <code>--key-renew-period</code> flag, which defaults to 30 days.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="disaster-recovery"></a>Disaster Recovery<a class="hash-link" href="#disaster-recovery" title="Direct link to heading">#</a></h2><p>If you suspect that a private key has been compromised you can consider that all sealed secrets that have been encrypted with it are compromised as well. In this case you need to change all sensitive values of the secrets, create a new sealing key and reencrypt all secrets. The steps in this case are:</p><ol><li><p>Change all sensitive data of your secrets</p></li><li><p>Retrieve the compromised private key from the cluster and delete it</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get secret --namespace kube-system sealed-secrets-key --output yaml </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> compromised-sealed-secrets-key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete secret --namespace kube-system sealed-secrets-key</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Restart the sealed-secrets-controller pod</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl delete pods --namespace kube-system sealed-secrets-controller-</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">hash</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>When the new pod starts, it will create a new private key</p></li><li><p>Get the new certificate and store it locally</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubeseal --fetch-cert </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> new-certificate.crt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Reseal your secrets with the new certificate</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubeseal --cert ./new-certificate.crt </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> SECRET.yaml --output yaml </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> SEALED_SECRET.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Commit them to your repo to create them</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> cluster/manifests/SEALED_SECRET.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> commit -m </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Added back re-sealed secret&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> push</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ol><p>The compromised secret key retrieved above can be used to decrypt any old sealed secrets if needed:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubeseal </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain"> SEALED_SECRET.yaml --recovery-unseal --recovery-private-key compromised-sealed-secrets-key --output yaml </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> UNSEALED_SECRET.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="reusing-the-sealing-key-in-multiple-clusters"></a>Reusing the Sealing Key in Multiple Clusters<a class="hash-link" href="#reusing-the-sealing-key-in-multiple-clusters" title="Direct link to heading">#</a></h2><p>For architectures where multiple clusters are managed by GitOps, reusing the same sealing key can decrease the operational complexity, if this process is within your security constraints. Keys are stored as standard Kubernetes secrets within a cluster, in the same namespace as the controller, usually <code>kube-system</code> under the name <code>sealed-secrets-key</code>.
To share keys between two clusters, assuming one cluster is operational and the second is being created:</p><ol><li><p>Extract the key from the first one</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get secret --namespace kube-system -l sealedsecrets.bitnami.com/sealed-secrets-key --output yaml </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> MASTER.yaml</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Commit it in the repo of your second cluster</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">cp</span><span class="token plain"> MASTER.yaml /path/to/my/second/repo/cluster/manifests</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">cd</span><span class="token plain"> /path/to/my/second/repo</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> cluster/manifests/MASTER.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> commit -m </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Added master key from cluster A&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> push</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Launch the workloads of the cluster as normal. As the sealed-secrets-controller starts it will read the key value from the secret and use it for decryption.</p></li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="secret-rotation"></a>Secret Rotation<a class="hash-link" href="#secret-rotation" title="Direct link to heading">#</a></h2><p>To create a WKP cluster, the required secret values are a deploy key for the git repository, alongside your docker credentials. These two values are sealed, with a similar process as described in the example section above, and stored in the repository in <code>cluster/platform/gitops-secrets.yaml</code>.</p><p>To rotate the sealed secret values when a new key is in place, first change directory to the top level directory of your github repository, then:</p><ol><li><p>Fetch the certificate for the new key. (<code>kubeseal</code> is installed in the <code>bin</code> directory of your installation)</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">./bin/kubeseal --fetch-cert </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> new-sealed-secrets-cert.crt</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>Run <code>wk gitops generate-secrets</code> (again, from the top level directory of your git repository) passing the new certificate, and push the new changes to the remote repository:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">wk gitops generate-secrets --git-private-key-file</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">setup/repo-key-</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">cluster-name</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --docker-io-user</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">my-docker-user</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> --docker-io-password-file</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">/path/to/my/docker/password --sealed-secrets-cert</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">new-sealed-secrets-cert.crt</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> ./cluster/platform/gitops-secrets.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> commit -m </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Rotated gitops-secrets.yaml&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> push</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li><li><p>After a few minutes the controller should decrypt the new sealed secrets.
You can verify this from the logs, as for example:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl logs -n kube-system -l </span><span class="token assign-left variable" style="color:rgb(191, 199, 213)">name</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain">sealed-secrets-controller</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token number" style="color:rgb(247, 140, 108)">2020</span><span class="token plain">/04/14 </span><span class="token number" style="color:rgb(247, 140, 108)">11</span><span class="token plain">:48:57 Event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">v1.ObjectReference</span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain">Kind:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;SealedSecret&quot;</span><span class="token plain">, Namespace:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;wkp-ui&quot;</span><span class="token plain">, Name:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;wkp-ui-git-deploy-key&quot;</span><span class="token plain">, </span><span class="token environment constant" style="color:rgb(130, 170, 255)">UID</span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;2f58d047-7e3b-11ea-82fe-42010a840019&quot;</span><span class="token plain">, APIVersion:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;bitnami.com/v1alpha1&quot;</span><span class="token plain">, ResourceVersion:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;10170&quot;</span><span class="token plain">, FieldPath:</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">: type: </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Normal&#x27;</span><span class="token plain"> reason: </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;Unsealed&#x27;</span><span class="token plain"> SealedSecret unsealed successfully</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div></li></ol><p>This process rotates just the encrypted values in the sealed secrets stored in the git repository. It is recommended
to rotate the actual secret values, in this case these are the docker credentials and the git deploy key.
In that case, after step 4 it is required to restart the pods in the cluster that will mount the updated <code>Secrets</code>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="further-reading"></a>Further Reading<a class="hash-link" href="#further-reading" title="Direct link to heading">#</a></h3><ul><li><a href="https://github.com/bitnami-labs/sealed-secrets" target="_blank" rel="noopener noreferrer">Sealed Secrets github page</a></li><li><a href="https://www.katacoda.com/courses/kubernetes/sealed-secrets" target="_blank" rel="noopener noreferrer">Katacoda tutorial on creating Sealed Secrets</a></li><li><a href="https://playbook.stakater.com/content/workshop/sealed-secrets/management.html" target="_blank" rel="noopener noreferrer">Key Management Playbook</a></li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/weaveworks/wkp-docs/tree/main/versioned_docs/version-2.4.2/cluster-operations/managing-secrets.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/wkp-docs/docs/cluster-operations/auth"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Securing the WKP UI</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/wkp-docs/docs/cluster-operations/sealing-key"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Managing the Sealing Key Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#example-creating-a-sealed-secret" class="table-of-contents__link">Example: Creating a sealed secret</a></li><li><a href="#scopes" class="table-of-contents__link">Scopes</a></li><li><a href="#key-renewal" class="table-of-contents__link">Key Renewal</a></li><li><a href="#disaster-recovery" class="table-of-contents__link">Disaster Recovery</a></li><li><a href="#reusing-the-sealing-key-in-multiple-clusters" class="table-of-contents__link">Reusing the Sealing Key in Multiple Clusters</a></li><li><a href="#secret-rotation" class="table-of-contents__link">Secret Rotation</a><ul><li><a href="#further-reading" class="table-of-contents__link">Further Reading</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Support</h4><ul class="footer__items"><li class="footer__item"><a href="mailto:support@weave.works" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Weaveworks</div></div></div></footer></div>
<script src="/wkp-docs/assets/js/styles.abc77443.js"></script>
<script src="/wkp-docs/assets/js/runtime~main.b973e4df.js"></script>
<script src="/wkp-docs/assets/js/main.d93e75c0.js"></script>
<script src="/wkp-docs/assets/js/1.7b0384ce.js"></script>
<script src="/wkp-docs/assets/js/2.e71b656c.js"></script>
<script src="/wkp-docs/assets/js/98.cac1137d.js"></script>
<script src="/wkp-docs/assets/js/100.a80eb3bc.js"></script>
<script src="/wkp-docs/assets/js/cb9bbae0.3572c2dc.js"></script>
<script src="/wkp-docs/assets/js/17896441.bd7294b6.js"></script>
<script src="/wkp-docs/assets/js/9dd5f212.3a057d1c.js"></script>
</body>
</html>