<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/wkp/blog/rss.xml" title="WKP Technical Documentation Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/wkp/blog/atom.xml" title="WKP Technical Documentation Blog Atom Feed"><title data-react-helmet="true">Securing the WKP UI | WKP Technical Documentation</title><meta data-react-helmet="true" property="og:url" content="https://weaveworks.github.io/wkp-docs//wkp/docs/next/cluster-operations/auth"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Securing the WKP UI | WKP Technical Documentation"><meta data-react-helmet="true" name="description" content="Before exposing the WKP UI publicly, you need to setup a way to authenticate your users as well as provision SSL certificates for the HTTPS endpoints. You also need an ingress controller that can handle ingress requests deployed either as a LoadBalancer or NodePort service."><meta data-react-helmet="true" property="og:description" content="Before exposing the WKP UI publicly, you need to setup a way to authenticate your users as well as provision SSL certificates for the HTTPS endpoints. You also need an ingress controller that can handle ingress requests deployed either as a LoadBalancer or NodePort service."><link data-react-helmet="true" rel="shortcut icon" href="/wkp/img/favicon_150px.png"><link data-react-helmet="true" rel="canonical" href="https://weaveworks.github.io/wkp-docs//wkp/docs/next/cluster-operations/auth"><link data-react-helmet="true" rel="alternate" href="https://weaveworks.github.io/wkp-docs//wkp/docs/next/cluster-operations/auth" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://weaveworks.github.io/wkp-docs//wkp/docs/next/cluster-operations/auth" hreflang="x-default"><link rel="stylesheet" href="/wkp/assets/css/styles.7e876baf.css">
<link rel="preload" href="/wkp/assets/js/styles.abc77443.js" as="script">
<link rel="preload" href="/wkp/assets/js/runtime~main.1ecede88.js" as="script">
<link rel="preload" href="/wkp/assets/js/main.d34c52c6.js" as="script">
<link rel="preload" href="/wkp/assets/js/1.7b0384ce.js" as="script">
<link rel="preload" href="/wkp/assets/js/2.e71b656c.js" as="script">
<link rel="preload" href="/wkp/assets/js/98.cac1137d.js" as="script">
<link rel="preload" href="/wkp/assets/js/100.a80eb3bc.js" as="script">
<link rel="preload" href="/wkp/assets/js/935f2afb.d09144ed.js" as="script">
<link rel="preload" href="/wkp/assets/js/17896441.bd7294b6.js" as="script">
<link rel="preload" href="/wkp/assets/js/87572f58.a6028343.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/wkp/"><img src="/wkp/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/wkp/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">WKP Docs</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp/docs/">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp/docs/deploying-wkp/hosts">Install</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp/docs/tasks/using-the-eks-d-distribution">Tasks</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp/docs/cluster-operations/user-workloads">Cluster Operations</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/wkp/docs/next/">main</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/wkp/docs/next/cluster-operations/auth">main</a></li><li><a class="dropdown__link" href="/wkp/docs/cluster-operations/auth">2.4.2</a></li></ul></div><a href="https://github.com/weaveworks/wkp-docs/tree/main" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/wkp/"><img src="/wkp/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/wkp/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">WKP Docs</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp/docs/">Getting Started</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp/docs/deploying-wkp/hosts">Install</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp/docs/tasks/using-the-eks-d-distribution">Tasks</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp/docs/cluster-operations/user-workloads">Cluster Operations</a></li><li class="menu__list-item"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/wkp/docs/next/cluster-operations/auth">main</a></li><li class="menu__list-item"><a class="menu__link" href="/wkp/docs/cluster-operations/auth">2.4.2</a></li></ul></li><li class="menu__list-item"><a href="https://github.com/weaveworks/wkp-docs/tree/main" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/">Introduction to wk</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/getting-started/wk">The wk command</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/getting-started/entitlements">Configuring Entitlements</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/getting-started/git-config-repository">Managing the Git Configuration Repository</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/getting-started/known-issues">Known Issues and Work Arounds</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Deploying WKP</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/hosts">Cluster Node Requirements</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/cluster-creation-on-ssh-nodes">Creating Clusters on SSH Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/components-on-existing-cluster">Install to an Existing Cluster</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/cluster-creation-on-eks">Installing WKP to EKS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/cluster-creation-on-ssh-nodes">Creating Clusters on SSH Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/cluster-creation-on-footloose">Installing WKP on Footloose</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Multi-cluster Control Plane</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/mccp/intro">What is Multi-cluster Control Plane?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/mccp/database-configuration">Configuring a Database</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/mccp/usage-guide">Connecting Clusters</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Team Workspaces</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/team-workspaces/usage-guide">Implementing Team Workspaces</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/team-workspaces/team-permissions">Specifying Team Permissions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/team-workspaces/member-guide">Deploying Workloads</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Cluster Operations</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/user-workloads">Running and Managing Workloads</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/adding-removing-nodes">Adding and Removing Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/upgrading-kubernetes-version">Upgrading Kubernetes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/custom-kubernetes-configuration">Customizing the API Server and Kubelet</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/wkp/docs/next/cluster-operations/auth">Securing the WKP UI</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/managing-secrets">Managing Secrets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/sealing-key">Managing the Sealing Key</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Monitoring</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/monitoring/introduction">WKP Monitoring Tools</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/monitoring/alerts">Alerts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/monitoring/dashboards">Dashboards</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Tasks</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/control-plane-load-balancers">Control Plane Load Balancing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/using-the-eks-d-distribution">Configuring EKS-D</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/multiple-cluster-admins">Specifying Multiple Admins</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/patching-node-os-packages">Patching Node OS packages</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/profiling-kubectl">Profiling kubectl</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Troubleshooting</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/troubleshooting/help">Debugging a Problem</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/troubleshooting/kubelet">Troubleshooting kubelet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/troubleshooting/controller">Troubleshooting wks-controller</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/troubleshooting/scope">WKP Scope</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/patching-node-os-packages">Patching Node OS packages</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/profiling-kubectl">Profiling kubectl</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">FAQ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/FAQ/faq">Frequently Asked Questions</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/reference/reference">Cluster and Machine Objects</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/reference/cluster">cluster.yaml</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/reference/machines">machines.yaml</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Thirdparty Dependencies</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deps/dependencies">Third-party Dependencies</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for WKP Technical Documentation <strong>main</strong> version.</div><div class="margin-top--md">For up-to-date documentation, see the <strong><a href="/wkp/docs/cluster-operations/auth">latest version</a></strong> (2.4.2).</div></div><div class="docItemContainer_33ec"><article><div><span class="badge badge--secondary">Version: main</span></div><header><h1 class="docTitle_3a4h">Securing the WKP UI</h1></header><div class="markdown"><p>Before exposing the WKP UI publicly, you need to setup a way to authenticate your users as well as provision SSL certificates for the HTTPS endpoints. You also need an ingress controller that can handle ingress requests deployed either as a <code>LoadBalancer</code> or <code>NodePort</code> service.</p><p>Here is an overview of the steps necessary to expose and secure your cluster</p><ul><li>Install an [ingress controller]({{&lt; ref &quot;#ingress-controller&quot; &gt;}} &quot;Ingress Controller&quot;) to expose internal services outside the cluster</li><li>Add <a href="#ssl-certificates">TLS/HTTPS</a> to access this securely </li><li>Deploy and configure oauth2-proxy to <a href="#authentication">allow</a> only members of your organization to access the UI</li><li><a href="#expose">Expose</a> the internal WKP UI service publicly through an ingress and keep it secure by redirecting any unauthenticated users to GitHub or GitLab through the use of NGINX annotations</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ingress-controller"></a>Ingress Controller<a class="hash-link" href="#ingress-controller" title="Direct link to heading">#</a></h3><p>If you already have an ingress controller running on your WKP cluster, feel free to skip to the next section. Otherwise, use the following manifest to install the NGINX ingress controller as a <code>NodePort</code> service.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Namespace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: ingress-nginx</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: helm.fluxcd.io/v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: HelmRelease</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: nginx-ingress-controller</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: ingress-nginx</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  helmVersion: v3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  releaseName: nginx-ingress-controller</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  chart:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: nginx-ingress-controller</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    version: 7.4.6</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    repository: https://charts.bitnami.com/bitnami</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  values:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    service:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      type: NodePort</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>You should now have an NGINX ingress controller running on your cluster as a <code>NodePort</code> service. To find out which ports are being exposed, use the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get services -n ingress-nginx nginx-ingress-controller</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>You can validate that the ingress controller is externally accessible via your configured DNS name by testing it with curl:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">curl http://example.org:&lt;port&gt;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="ssl-certificates"></a>SSL Certificates<a class="hash-link" href="#ssl-certificates" title="Direct link to heading">#</a></h3><p>The recommended way to provision SSL certificates in Kubernetes is through <a href="https://cert-manager.io/" target="_blank" rel="noopener noreferrer">cert-manager</a>. Use the following manifests to install cert-manager on your WKP cluster.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Namespace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: cert-manager</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: helm.fluxcd.io/v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: HelmRelease</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: cert-manager</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: cert-manager</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  releaseName: cert-manager</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  chart:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    name: cert-manager</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    version: v1.2.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    repository: https://charts.jetstack.io</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  values:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    installCRDs: true</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>At this point, you should have cert-manager running in the <code>cert-manager</code> namespace. To continue, you need to create <code>Issuer</code> or <code>ClusterIssuer</code> resources. These represent certificate authorities that can generate signed certificates. An <code>Issuer</code> is a namespaced resource, used to issue certificates in its current namespace. A <code>ClusterIssuer</code> is not namespaced and can be used to issue certificates across all namespaces. </p><p>For example, the following manifest creates a cluster-wide issuer that uses Let&#x27;s Encrypt to issue certificates and is configured to use an <a href="https://cert-manager.io/docs/configuration/acme/http01/" target="_blank" rel="noopener noreferrer">HTTP01</a> challenge. The ingress class is used to indicate which ingress controller will be used to expose a well known endpoint for the purpose of solving the validation challenge.  </p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: cert-manager.io/v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ClusterIssuer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: letsencrypt-prod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  acme:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    email: &lt;your-email&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    server: https://acme-v02.api.letsencrypt.org/directory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    privateKeySecretRef:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      name: letsencrypt-prod-account-key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    solvers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - http01:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ingress:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          class: nginx</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>An issuer that uses the HTTP01 challenge solver is useful when there is already a DNS name setup for the UI and the ingress controller is exposing HTTP/S in ports 80/443 (as is the case when it has been deployed as a <code>LoadBalancer</code> service). When the ingress controller is deployed as a <code>NodePort</code> service (as mentioned above), the DNS01 challenge can be used instead. The following manifest shows how to create a <code>ClusterIssuer</code> that is configured to use the DNS01 challenge. In this example, the issuer references a key and a secret which holds the credentials for an IAM user with permissions to update the AWS Route53 DNS service. Other DNS providers can also be configured accordingly.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">--</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">data:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  secret-access-key: &lt;base64-encoded-secret-access-key&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Secret</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  creationTimestamp: null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: route53-credentials</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: cert-manager</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: cert-manager.io/v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ClusterIssuer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: letsencrypt-prod</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  acme:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    email: &lt;your-email&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    server: https://acme-v02.api.letsencrypt.org/directory</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    privateKeySecretRef:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      name: letsencrypt-prod-account-key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    solvers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - dns01:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        route53:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          region: eu-west-1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          accessKeyID: &lt;access-key-with-route53-permissions&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          secretAccessKeySecretRef:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            name: route53-credentials</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            key: secret-access-key</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Of course, you can also supply your own CA certificates and use them to issue new certificates. This can be useful in air gapped environments where it&#x27;s not practical to use an ACME provider such as Let&#x27;s Encrypt. The following manifest shows an example of that.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Secret</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: ca-key-pair</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: cert-manager</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">data:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tls.crt: &lt;your-tls-cert&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tls.key: &lt;your-tls-key&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: cert-manager.io/v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: ClusterIssuer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: ca-issuer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ca:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    secretName: ca-key-pair</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Cert-manager should now be ready and configured to issue certificates for ingress resources that include the annotation: <code>cert-manager.io/cluster-issuer: &lt;name-of-your-cluster-issuer&gt;</code> (or <code>cert-manager.io/issuer: &lt;name-of-your-issuer&gt;</code> for namespaced issuers).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="authentication"></a>Authentication<a class="hash-link" href="#authentication" title="Direct link to heading">#</a></h3><p>To set up authentication, you need to install <a href="https://oauth2-proxy.github.io/oauth2-proxy/" target="_blank" rel="noopener noreferrer">oauth2-proxy</a> which acts as a reverse proxy for the endpoints you need to secure and can authenticate users using a variety of auth providers such as GitHub or GitLab.  Before configuring oauth2-proxy, you need to create an OAuth2 application in your preferred authentication provider. The sections below describe how to set this up for GitHub or GitLab.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="github"></a>GitHub<a class="hash-link" href="#github" title="Direct link to heading">#</a></h4><ol><li>Before setting up GitHub authentication you need to create an OAuth application. Oauth2-proxy will be configured to use this application to authenticate users against a GitHub team. To create a new OAuth application, navigate to your <a href="https://github.com/settings/developers" target="_blank" rel="noopener noreferrer">settings</a> page in your GitHub profile, click the button <code>New OAuth App</code> and fill in the form presented.<ul><li>Application name: the name of the application will be presented to users when they are being asked to authenticate. </li><li>Homepage URL: the homepage url will typically be the URL of your WKP UI i.e. <code>https://example.com</code>. </li><li>Authorization callback URL: the authorization callback URL will be the URL where users are sent after they authorize with GitHub. When using oauth2-proxy this is typically a path of the main application URL that oauth2-proxy will serve i.e. <code>https://example.com/oauth2/callback</code>. If you use a <code>NodePort</code> service for your ingress controller (as mentioned above), you need to add the corresponding HTTPS port that the controller listens to, to both of these links.</li></ul></li><li>Upon creating an OAuth application, you will be presented with a <code>Client ID</code>. Click on the <code>Generate new client secret</code> button to also generate a client secret for this application. Take note of these two values as you will be adding them to your cluster later as a Kubernetes secret. </li></ol><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="gitlab"></a>GitLab<a class="hash-link" href="#gitlab" title="Direct link to heading">#</a></h4><ol><li>Before setting up GitLab authentication you need to create an OAuth application. Oauth2-proxy will be configured to use this application to authenticate users against a GitLab group. To create a new OAuth application, navigate to your <a href="https://gitlab.com/oauth/applications" target="_blank" rel="noopener noreferrer">applications</a> page in your GitLab profile and fill in the form presented.<ul><li>Name: the name of the app will be presented to users when they are being asked to authenticate. </li><li>Redirect URI: the redirect URI will be the URL where users are sent after they authorize with GitLab. When using oauth2-proxy this is typically a path of the main application URL that oauth2-proxy will serve i.e. <code>https://example.com/oauth2/callback</code>. If you use a <code>NodePort</code> service for your ingress controller (as mentioned above), you need to add the corresponding HTTPS port that the controller listens to to this URL.</li><li>Confidential: leave the checkbox checked as the client details will not be shared publicly.</li><li>Scopes: make sure <code>openid</code>, <code>profile</code> and <code>email</code> scopes are selected. You may select additional scopes beyond those if needed.</li></ul></li><li>Upon creating an OAuth application, you will be presented with a <code>Application ID</code> and <code>Secret</code>. Take note of these two values as you will be adding them to your cluster later as a Kubernetes secret.</li></ol><p>Once an OAuth application has been established in your chosen git provider, you will also need to generate a seed value that oauth2-proxy will use for issuing secure cookies. To do that issue the following command:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">docker run -ti --rm python:3-alpine python -c &#x27;import secrets,base64; print(base64.b64encode(base64.b64encode(secrets.token_bytes(16))));&#x27;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Now you are ready to configure and deploy oauth2-proxy to your cluster. First, create a secret with the OAuth application details (client id and client secret) and the cookie seed value that was generated previously. Then use the following manifest to deploy oauth2-proxy to your cluster (substituting values where necessary):</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Namespace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">data:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  client-id: &lt;base64-encoded-client-id&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  client-secret: &lt;base64-encoded-client-secret&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cookie-secret: &lt;base64-encoded-cookie-secret&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Secret</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  creationTimestamp: null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: apps/v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Deployment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  replicas: 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  selector:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    matchLabels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      app: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  template:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      labels:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        app: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      containers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - name: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        image: quay.io/oauth2-proxy/oauth2-proxy:v7.0.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        imagePullPolicy: Always</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        args:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ## Using github for authentication</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - --provider=github</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - --github-org=&lt;your-github-org&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - --github-team=&lt;your-github-team&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ## Uncomment these lines if using gitlab for authentication</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        # - --provider=gitlab</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        # - --gitlab-group=&lt;your-gitlab-group&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        # - --redirect-url=&lt;your-redirect-uri&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - --email-domain=&quot;*&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - --upstream=file:///dev/null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - --http-address=0.0.0.0:4180</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - --set-xauthrequest=true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - --pass-access-token=true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        env:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          - name: OAUTH2_PROXY_CLIENT_ID</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            valueFrom:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              secretKeyRef:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                name: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                key: client-id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          - name: OAUTH2_PROXY_CLIENT_SECRET</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            valueFrom:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              secretKeyRef:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                name: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                key: client-secret</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          - name: OAUTH2_PROXY_COOKIE_SECRET</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            valueFrom:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">              secretKeyRef:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                name: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">                key: cookie-secret</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        ports:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        - containerPort: 4180</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          protocol: TCP</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Service</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ports:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - name: http</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    port: 4180</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    protocol: TCP</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    targetPort: 4180</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  selector:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    app: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: networking.k8s.io/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Ingress</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  annotations:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    kubernetes.io/ingress.class: nginx</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cert-manager.io/cluster-issuer: letsencrypt-prod </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  rules:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - host: &lt;hostname-to-use&gt; # e.g. example.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    http:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      paths:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - path: /oauth2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        backend:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          serviceName: oauth2-proxy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          servicePort: 4180</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tls:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - hosts:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - &lt;hostname-to-use&gt; # e.g. example.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    secretName: wkp-tls</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>You should now have an ingress route for host <code>https://example.com/oauth2</code> that routes to the oauth2-proxy pod currently running.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="expose"></a>Expose the UI<a class="hash-link" href="#expose" title="Direct link to heading">#</a></h3><p>At this point, everything should be in place to expose the UI publicly. To create a new ingress route for the UI use the following  manifest. The <code>nginx.ingress.kubernetes.io/auth-url</code> and <code>nginx.ingress.kubernetes.io/auth-signin</code> annotations used will instruct NGINX to redirect unauthenticated requests to oauth2-proxy.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">---</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">apiVersion: networking.k8s.io/v1beta1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">kind: Ingress</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">metadata:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  annotations:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    kubernetes.io/ingress.class: nginx</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cert-manager.io/cluster-issuer: letsencrypt-prod </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    nginx.ingress.kubernetes.io/auth-url: &quot;https://$host:&lt;port-if-not-443&gt;/oauth2/auth&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    nginx.ingress.kubernetes.io/auth-signin: &quot;https://$host:&lt;port-if-not-443&gt;/oauth2/start?rd=$escaped_request_uri&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    nginx.ingress.kubernetes.io/auth-response-headers: &quot;X-Auth-Request-User, X-Auth-Request-Email&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  name: public-wkp-ui</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  namespace: wkp-ui</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  rules:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - host: &lt;hostname-to-use&gt; # e.g. example.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    http:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      paths:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      - path: /</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        backend:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          serviceName: wkp-ui-nginx-ingress-controller</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          servicePort: 80</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  tls:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  - hosts:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    - &lt;hostname-to-use&gt; # e.g. example.com</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    secretName: wkp-tls</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><blockquote><p><strong>Note:</strong> You may also need to add an ingress rule to exclude the /gitops/api/agent.yaml endpoint.
Please refer to the MCCP usage section of the user guide for detailed instructions on how to do that.</p></blockquote><p>You should now be able to log in to the WKP UI securely by authenticating to GitHub or GitLab first.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/weaveworks/wkp-docs/tree/main/docs/cluster-operations/auth.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/wkp/docs/next/cluster-operations/custom-kubernetes-configuration"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Customizing the API Server and Kubelet</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/wkp/docs/next/cluster-operations/managing-secrets"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Managing Secrets Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#ingress-controller" class="table-of-contents__link">Ingress Controller</a></li><li><a href="#ssl-certificates" class="table-of-contents__link">SSL Certificates</a></li><li><a href="#authentication" class="table-of-contents__link">Authentication</a></li><li><a href="#expose" class="table-of-contents__link">Expose the UI</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Support</h4><ul class="footer__items"><li class="footer__item"><a href="mailto:support@weave.works" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Weaveworks</div></div></div></footer></div>
<script src="/wkp/assets/js/styles.abc77443.js"></script>
<script src="/wkp/assets/js/runtime~main.1ecede88.js"></script>
<script src="/wkp/assets/js/main.d34c52c6.js"></script>
<script src="/wkp/assets/js/1.7b0384ce.js"></script>
<script src="/wkp/assets/js/2.e71b656c.js"></script>
<script src="/wkp/assets/js/98.cac1137d.js"></script>
<script src="/wkp/assets/js/100.a80eb3bc.js"></script>
<script src="/wkp/assets/js/935f2afb.d09144ed.js"></script>
<script src="/wkp/assets/js/17896441.bd7294b6.js"></script>
<script src="/wkp/assets/js/87572f58.a6028343.js"></script>
</body>
</html>