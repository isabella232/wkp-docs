<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/wkp/blog/rss.xml" title="WKP Technical Documentation Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/wkp/blog/atom.xml" title="WKP Technical Documentation Blog Atom Feed"><title data-react-helmet="true">Running and Managing Workloads | WKP Technical Documentation</title><meta data-react-helmet="true" property="og:url" content="https://weaveworks.github.io/wkp-docs//wkp/docs/next/cluster-operations/user-workloads"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Running and Managing Workloads | WKP Technical Documentation"><meta data-react-helmet="true" name="description" content="Running user workloads"><meta data-react-helmet="true" property="og:description" content="Running user workloads"><link data-react-helmet="true" rel="shortcut icon" href="/wkp/img/favicon_150px.png"><link data-react-helmet="true" rel="canonical" href="https://weaveworks.github.io/wkp-docs//wkp/docs/next/cluster-operations/user-workloads"><link data-react-helmet="true" rel="alternate" href="https://weaveworks.github.io/wkp-docs//wkp/docs/next/cluster-operations/user-workloads" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://weaveworks.github.io/wkp-docs//wkp/docs/next/cluster-operations/user-workloads" hreflang="x-default"><link rel="stylesheet" href="/wkp/assets/css/styles.7e876baf.css">
<link rel="preload" href="/wkp/assets/js/styles.abc77443.js" as="script">
<link rel="preload" href="/wkp/assets/js/runtime~main.bd194a0e.js" as="script">
<link rel="preload" href="/wkp/assets/js/main.1725b613.js" as="script">
<link rel="preload" href="/wkp/assets/js/1.7b0384ce.js" as="script">
<link rel="preload" href="/wkp/assets/js/2.e71b656c.js" as="script">
<link rel="preload" href="/wkp/assets/js/98.cac1137d.js" as="script">
<link rel="preload" href="/wkp/assets/js/100.a80eb3bc.js" as="script">
<link rel="preload" href="/wkp/assets/js/935f2afb.d09144ed.js" as="script">
<link rel="preload" href="/wkp/assets/js/17896441.bd7294b6.js" as="script">
<link rel="preload" href="/wkp/assets/js/f4643dd9.2d8a0a98.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/wkp/"><img src="/wkp/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/wkp/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">WKP Docs</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp/docs/">Getting Started</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp/docs/deploying-wkp/hosts">Install</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp/docs/tasks/using-the-eks-d-distribution">Tasks</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/wkp/docs/cluster-operations/user-workloads">Cluster Operations</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__item navbar__link" href="/wkp/docs/next/">main</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/wkp/docs/next/cluster-operations/user-workloads">main</a></li><li><a class="dropdown__link" href="/wkp/docs/cluster-operations/user-workloads">2.4.2</a></li></ul></div><a href="https://github.com/weaveworks/wkp-docs/tree/main" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/wkp/"><img src="/wkp/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/wkp/img/weave-logo.png" alt="WKP docs" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">WKP Docs</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp/docs/">Getting Started</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp/docs/deploying-wkp/hosts">Install</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp/docs/tasks/using-the-eks-d-distribution">Tasks</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/wkp/docs/cluster-operations/user-workloads">Cluster Operations</a></li><li class="menu__list-item"><a role="button" class="menu__link menu__link--sublist">Versions</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active" href="/wkp/docs/next/cluster-operations/user-workloads">main</a></li><li class="menu__list-item"><a class="menu__link" href="/wkp/docs/cluster-operations/user-workloads">2.4.2</a></li></ul></li><li class="menu__list-item"><a href="https://github.com/weaveworks/wkp-docs/tree/main" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/">Introduction to wk</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/getting-started/wk">The wk command</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/getting-started/entitlements">Configuring Entitlements</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/getting-started/git-config-repository">Managing the Git Configuration Repository</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/getting-started/known-issues">Known Issues and Work Arounds</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Deploying WKP</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/hosts">Cluster Node Requirements</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/cluster-creation-on-ssh-nodes">Creating Clusters on SSH Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/components-on-existing-cluster">Install to an Existing Cluster</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/cluster-creation-on-eks">Installing WKP to EKS</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/cluster-creation-on-ssh-nodes">Creating Clusters on SSH Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deploying-wkp/cluster-creation-on-footloose">Installing WKP on Footloose</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Multi-cluster Control Plane</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/mccp/intro">What is Multi-cluster Control Plane?</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/mccp/database-configuration">Configuring a Database</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/mccp/usage-guide">Connecting Clusters</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Team Workspaces</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/team-workspaces/usage-guide">Implementing Team Workspaces</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/team-workspaces/team-permissions">Specifying Team Permissions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/team-workspaces/member-guide">Deploying Workloads</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Cluster Operations</a><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/wkp/docs/next/cluster-operations/user-workloads">Running and Managing Workloads</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/adding-removing-nodes">Adding and Removing Nodes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/upgrading-kubernetes-version">Upgrading Kubernetes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/custom-kubernetes-configuration">Customizing the API Server and Kubelet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/auth">Securing the WKP UI</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/managing-secrets">Managing Secrets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/wkp/docs/next/cluster-operations/sealing-key">Managing the Sealing Key</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Monitoring</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/monitoring/introduction">WKP Monitoring Tools</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/monitoring/alerts">Alerts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/monitoring/dashboards">Dashboards</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Tasks</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/control-plane-load-balancers">Control Plane Load Balancing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/using-the-eks-d-distribution">Configuring EKS-D</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/multiple-cluster-admins">Specifying Multiple Admins</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/patching-node-os-packages">Patching Node OS packages</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/profiling-kubectl">Profiling kubectl</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Troubleshooting</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/troubleshooting/help">Debugging a Problem</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/troubleshooting/kubelet">Troubleshooting kubelet</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/troubleshooting/controller">Troubleshooting wks-controller</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/troubleshooting/scope">WKP Scope</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/patching-node-os-packages">Patching Node OS packages</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/tasks/profiling-kubectl">Profiling kubectl</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">FAQ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/FAQ/faq">Frequently Asked Questions</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/reference/reference">Cluster and Machine Objects</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/reference/cluster">cluster.yaml</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/reference/machines">machines.yaml</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Thirdparty Dependencies</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/wkp/docs/next/deps/dependencies">Third-party Dependencies</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for WKP Technical Documentation <strong>main</strong> version.</div><div class="margin-top--md">For up-to-date documentation, see the <strong><a href="/wkp/docs/cluster-operations/user-workloads">latest version</a></strong> (2.4.2).</div></div><div class="docItemContainer_33ec"><article><div><span class="badge badge--secondary">Version: main</span></div><header><h1 class="docTitle_3a4h">Running and Managing Workloads</h1></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="running-user-workloads"></a>Running user workloads<a class="hash-link" href="#running-user-workloads" title="Direct link to heading">#</a></h3><p>Once your cluster is up and running it&#x27;s time to put it work!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="managing-workloads-with-gitops"></a>Managing workloads with GitOps<a class="hash-link" href="#managing-workloads-with-gitops" title="Direct link to heading">#</a></h3><p>WKP encourages using GitOps to manage your workloads. We can specify the state of the cluster including all our user workloads in the config git repository. The <em>WKP Flux</em> Cluster Component will ensure that the git repository and the cluster then stay in sync. This gives us a number of benefits including</p><ul><li>An audit trail of who deployed or updated a workload and why</li><li>Deployment rollbacks via <code>git revert</code></li></ul><p>Additionally WKP clusters support all the traditional ways of creating and deploying workloads through <code>kubectl</code> and the api-server directly. Check out the <a href="https://kubernetes.io/docs/tasks/" target="_blank" rel="noopener noreferrer">Kubernetes docs</a> to familiarize yourself with these tools.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="adding-a-workload"></a>Adding a workload<a class="hash-link" href="#adding-a-workload" title="Direct link to heading">#</a></h3><p>By default the <code>./cluster/manifests</code> path within the config repository is reserved for user manifests. Any <code>.yaml</code> Kubernetes manifest you add within this path will be deployed to the cluster automatically.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="example-adding-nginx"></a>Example: Adding nginx<a class="hash-link" href="#example-adding-nginx" title="Direct link to heading">#</a></h4><p>Lets create a new file: <code>./cluster/manifests/nginx.yaml</code> and set the contents:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly yaml"><div tabindex="0" class="prism-code language-yaml codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> apps/v1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> Deployment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain">deployment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">selector</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">matchLabels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">replicas</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token key atrule">template</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">labels</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token key atrule">app</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> nginx</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain">1.14.2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token key atrule">ports</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(199, 146, 234)">-</span><span class="token plain"> </span><span class="token key atrule">containerPort</span><span class="token punctuation" style="color:rgb(199, 146, 234)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">80</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Save the file, then we&#x27;ll commit and push it to the repository host</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">add</span><span class="token plain"> ./cluster/manifests/nginx.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> commit -m </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;Deploying nginx to the cluster&quot;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token function" style="color:rgb(130, 170, 255)">git</span><span class="token plain"> push origin master</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="checking-a-workload-is-deployed"></a>Checking a workload is deployed<a class="hash-link" href="#checking-a-workload-is-deployed" title="Direct link to heading">#</a></h3><p>Once we have pushed we can check the workload is deployed in the cluster like with <code>kubectl</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly bash"><div tabindex="0" class="prism-code language-bash codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl get pods</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NAME                                READY   STATUS    RESTARTS   AGE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">nginx-deployment-574b87c764-mth9r   </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain">/1     Running   </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain">          16s</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>There is a new pod running!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="view-the-new-workload-in-weave-scope"></a>View the new workload in Weave Scope<a class="hash-link" href="#view-the-new-workload-in-weave-scope" title="Direct link to heading">#</a></h3><p>We can use the Weave Scope Cluster Component to view all the workloads running on the cluster. First open the WKP ui</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><div tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">wk ui</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Then when the browser opens click the &quot;Open Scope&quot; button in the Cluster Components list. You can use Scope to explore whats running on your cluster.</p><p><img alt="Nginx in Scope" src="/wkp/assets/images/scope-nginx-detail-7be77c629ffc8c57a4bb3456d46c4404.png"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="view-the-ui"></a>View the UI<a class="hash-link" href="#view-the-ui" title="Direct link to heading">#</a></h3><p>We can view the Web UI of a pod by forwarding the http ports it listens on</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><div tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl port-forward deployment/nginx-deployment 8080:80</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>opening <a href="http://localhost:8080" target="_blank" rel="noopener noreferrer">http://localhost:8080</a> in your browser will show the default nginx server response</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="check-logs"></a>Check logs<a class="hash-link" href="#check-logs" title="Direct link to heading">#</a></h3><p>We can check the logs of our new pod via kubectl</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><div tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl logs deployment/nginx-deployment</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">127.0.0.1 - - [05/Jun/2020:10:15:26 +0000] &quot;GET / HTTP/1.1&quot; 200 612 &quot;-&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Safari/605.1.15&quot; &quot;-&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">127.0.0.1 - - [05/Jun/2020:10:15:26 +0000] &quot;GET /favicon.ico HTTP/1.1&quot; 404 169 &quot;http://localhost:8080/&quot; &quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.1 Safari/605.1.15&quot; &quot;-&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2020/06/05 10:15:26 [error] 6#6: *1 open() &quot;/usr/share/nginx/html/favicon.ico&quot; failed (2: No such file or directory), client: 127.0.0.1, server: localhost, request: &quot;GET /favicon.ico HTTP/1.1&quot;, host: &quot;localhost:8080&quot;, referrer: &quot;http://localhost:8080/&quot;</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>displaying the requests we just made.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="updating-a-workload"></a>Updating a workload<a class="hash-link" href="#updating-a-workload" title="Direct link to heading">#</a></h3><p>A common operation is upgrading a version of a workload when there is a new release. To do that we can edit the <code>.yaml</code> file and change the docker image to the desired tag:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><div tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">vim cluster/manifests/nginx.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">git diff</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly diff"><div tabindex="0" class="prism-code language-diff codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">diff --git a/cluster/manifests/nginx.yaml b/cluster/manifests/nginx.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">index 91f07bf..198b404 100644</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token coord">--- a/cluster/manifests/nginx.yaml</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token coord">+++ b/cluster/manifests/nginx.yaml</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@@ -14,7 +14,7 @@ spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">    spec:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      containers:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">      - name: nginx</span></div><div class="token-line" style="color:#bfc7d5"><span class="token unchanged line"></span><span class="token deleted-sign deleted prefix deleted" style="color:rgb(255, 85, 114)">-</span><span class="token deleted-sign deleted line" style="color:rgb(255, 85, 114)">        image: nginx:1.14.2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token deleted-sign deleted line" style="color:rgb(255, 85, 114)"></span><span class="token inserted-sign inserted prefix inserted" style="color:rgb(195, 232, 141)">+</span><span class="token inserted-sign inserted line" style="color:rgb(195, 232, 141)">        image: nginx:1.16.1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token inserted-sign inserted line" style="color:rgb(195, 232, 141)"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        ports:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token unchanged line"></span><span class="token unchanged prefix unchanged"> </span><span class="token unchanged line">        - containerPort: 80</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Then once again we can commit and push to update the cluster:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><div tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">git add ./cluster/manifests/nginx.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">git commit -m &quot;Update nginx to 1.16.1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">git push origin master</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="debugging"></a>Debugging<a class="hash-link" href="#debugging" title="Direct link to heading">#</a></h3><p>If a change to the git repository does not seem to be reflected in the cluster we can take some steps to investigate</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="verify-the-flux-sync-git-tag"></a>Verify the <code>flux-sync</code> git tag<a class="hash-link" href="#verify-the-flux-sync-git-tag" title="Direct link to heading">#</a></h3><p>When flux applies a commit it will update a git tag on the repository. If you don&#x27;t have access to the flux pod&#x27;s logs this is a handy way of checking what was last sync&#x27;d:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><div tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">$ git pull</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">remote: Counting objects: 1, done.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">remote: Total 1 (delta 0), reused 0 (delta 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Unpacking objects: 100% (1/1), 148 bytes | 148.00 KiB/s, done.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">From gitlab.dev.wkp.weave.works:foot/simon-gcp-59</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * [new tag]         flux-sync  -&gt; flux-sync</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Already up to date.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>We can inspect the tag and see when flux last updated it and which commit was last applied.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><div tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">git show flux-sync -q</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">tag flux-sync</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Tagger: Weave Flux &lt;support@weave.works&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Date:   Fri Jun 5 10:12:29 2020 +0000</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Sync pointer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">commit d81af6571f525d924e896a5fbcd0706abd09a7ee (HEAD -&gt; master, tag: flux-sync, origin/master)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Author: WKP Support &lt;support@weave.works&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">Date:   Fri Jun 5 12:12:17 2020 +0200</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    Deploying nginx to the cluster</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Flux is configured by default to poll and apply the git repository every 10s. If after waiting this long the tag has not updated flux might be having trouble syncing the repository. To learn more we need to check its logs.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="check-the-flux-logs-for-errors"></a>Check the flux logs for errors<a class="hash-link" href="#check-the-flux-logs-for-errors" title="Direct link to heading">#</a></h3><p>We can inspect the flux logs with:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><div tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">kubectl logs -n wkp-flux deployment/flux</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Flux will report any errors raised while it was applying the yaml manifests. This can include things like:</p><ul><li>Unable to read the git repository if there are connectivity issues.</li><li>Syntax errors in the <code>.yaml</code> manifest files</li><li>Kubernetes validation errors if the manifest files are badly formed.</li></ul><p>Correct any errors in your yaml files and then try commiting and pushing your changes again.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="remove-a-workload"></a>Remove a workload<a class="hash-link" href="#remove-a-workload" title="Direct link to heading">#</a></h3><p>Removing a workload is again a simple operation on the config repository:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly console"><div tabindex="0" class="prism-code language-console codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">git rm ./cluster/manifests/nginx.yaml</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">git commit -m &quot;Removing nginx for now&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">git push origin master</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>Flux will sync and remove the workload from the cluster.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/weaveworks/wkp-docs/tree/main/docs/cluster-operations/user-workloads.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/wkp/docs/next/team-workspaces/member-guide"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Deploying Workloads</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/wkp/docs/next/cluster-operations/adding-removing-nodes"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Adding and Removing Nodes Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#running-user-workloads" class="table-of-contents__link">Running user workloads</a></li><li><a href="#managing-workloads-with-gitops" class="table-of-contents__link">Managing workloads with GitOps</a></li><li><a href="#adding-a-workload" class="table-of-contents__link">Adding a workload</a></li><li><a href="#checking-a-workload-is-deployed" class="table-of-contents__link">Checking a workload is deployed</a></li><li><a href="#view-the-new-workload-in-weave-scope" class="table-of-contents__link">View the new workload in Weave Scope</a></li><li><a href="#view-the-ui" class="table-of-contents__link">View the UI</a></li><li><a href="#check-logs" class="table-of-contents__link">Check logs</a></li><li><a href="#updating-a-workload" class="table-of-contents__link">Updating a workload</a></li><li><a href="#debugging" class="table-of-contents__link">Debugging</a></li><li><a href="#verify-the-flux-sync-git-tag" class="table-of-contents__link">Verify the <code>flux-sync</code> git tag</a></li><li><a href="#check-the-flux-logs-for-errors" class="table-of-contents__link">Check the flux logs for errors</a></li><li><a href="#remove-a-workload" class="table-of-contents__link">Remove a workload</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Support</h4><ul class="footer__items"><li class="footer__item"><a href="mailto:support@weave.works" target="_blank" rel="noopener noreferrer" class="footer__link-item">Contact Us</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Weaveworks</div></div></div></footer></div>
<script src="/wkp/assets/js/styles.abc77443.js"></script>
<script src="/wkp/assets/js/runtime~main.bd194a0e.js"></script>
<script src="/wkp/assets/js/main.1725b613.js"></script>
<script src="/wkp/assets/js/1.7b0384ce.js"></script>
<script src="/wkp/assets/js/2.e71b656c.js"></script>
<script src="/wkp/assets/js/98.cac1137d.js"></script>
<script src="/wkp/assets/js/100.a80eb3bc.js"></script>
<script src="/wkp/assets/js/935f2afb.d09144ed.js"></script>
<script src="/wkp/assets/js/17896441.bd7294b6.js"></script>
<script src="/wkp/assets/js/f4643dd9.2d8a0a98.js"></script>
</body>
</html>